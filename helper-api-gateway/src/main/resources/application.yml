server:
  port: 8080

spring:
  application:
    name: helper-api-gateway
  profiles:
    active: dev

  cloud:
    gateway:
      # ===== GLOBAL DEFAULTS =====
      default-filters:
        - name: RequestSize
          args:
            maxSize: 10MB
        - DedupeResponseHeader=Access-Control-Allow-Origin Access-Control-Allow-Credentials, RETAIN_FIRST

      # ===== ROUTE DEFINITIONS =====
      # Routes are matched in order — first match wins.
      # Pattern: /api/v1/{service-prefix}/** → http://service-host:port/api/v1/{service-prefix}/**
      routes:

        # ==========================================
        # 1. AUTH SERVICE (port 8081)
        # ==========================================
        - id: auth-service
          uri: ${AUTH_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/v1/auth/**
          filters:
            - name: CircuitBreaker
              args:
                name: authCircuitBreaker
                fallbackUri: forward:/fallback/auth

        # ==========================================
        # 2. TASK SERVICE (port 8082)
        # ==========================================
        - id: task-service
          uri: ${TASK_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/v1/tasks/**
          filters:
            - name: CircuitBreaker
              args:
                name: taskCircuitBreaker
                fallbackUri: forward:/fallback/task

        # Task service — admin endpoints
        - id: task-service-admin
          uri: ${TASK_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/v1/admin/tasks/**
          filters:
            - name: CircuitBreaker
              args:
                name: taskCircuitBreaker
                fallbackUri: forward:/fallback/task

        # ==========================================
        # 3. USER PROFILE + KYC SERVICE (port 8083)
        # ==========================================
        - id: user-service-profiles
          uri: ${USER_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/v1/profiles/**,/api/v1/workers/**,/api/v1/customers/**
          filters:
            - name: CircuitBreaker
              args:
                name: userCircuitBreaker
                fallbackUri: forward:/fallback/user

        - id: user-service-kyc
          uri: ${USER_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/v1/kyc/**
          filters:
            - name: CircuitBreaker
              args:
                name: userCircuitBreaker
                fallbackUri: forward:/fallback/user

        - id: user-service-admin
          uri: ${USER_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/v1/admin/kyc/**,/api/v1/admin/profiles/**
          filters:
            - name: CircuitBreaker
              args:
                name: userCircuitBreaker
                fallbackUri: forward:/fallback/user

        # ==========================================
        # 4. PAYMENT SERVICE (port 8084)
        # ==========================================
        - id: payment-service
          uri: ${PAYMENT_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/v1/payments/**
          filters:
            - name: CircuitBreaker
              args:
                name: paymentCircuitBreaker
                fallbackUri: forward:/fallback/payment

        - id: payment-service-ledger
          uri: ${PAYMENT_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/v1/ledger/**
          filters:
            - name: CircuitBreaker
              args:
                name: paymentCircuitBreaker
                fallbackUri: forward:/fallback/payment

        - id: payment-service-admin
          uri: ${PAYMENT_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/v1/admin/payments/**,/api/v1/admin/config/**
          filters:
            - name: CircuitBreaker
              args:
                name: paymentCircuitBreaker
                fallbackUri: forward:/fallback/payment

        # ==========================================
        # 5. RATING SERVICE (port 8085)
        # ==========================================
        - id: rating-service
          uri: ${RATING_SERVICE_URL:http://localhost:8085}
          predicates:
            - Path=/api/v1/ratings/**
          filters:
            - name: CircuitBreaker
              args:
                name: ratingCircuitBreaker
                fallbackUri: forward:/fallback/rating

        - id: rating-service-flags
          uri: ${RATING_SERVICE_URL:http://localhost:8085}
          predicates:
            - Path=/api/v1/flags/**
          filters:
            - name: CircuitBreaker
              args:
                name: ratingCircuitBreaker
                fallbackUri: forward:/fallback/rating

        - id: rating-service-admin
          uri: ${RATING_SERVICE_URL:http://localhost:8085}
          predicates:
            - Path=/api/v1/admin/ratings/**,/api/v1/admin/flags/**
          filters:
            - name: CircuitBreaker
              args:
                name: ratingCircuitBreaker
                fallbackUri: forward:/fallback/rating

        # ==========================================
        # 6. NOTIFICATION SERVICE (port 8086)
        # ==========================================
        - id: notification-service
          uri: ${NOTIFICATION_SERVICE_URL:http://localhost:8086}
          predicates:
            - Path=/api/v1/notifications/**
          filters:
            - name: CircuitBreaker
              args:
                name: notificationCircuitBreaker
                fallbackUri: forward:/fallback/notification

        - id: notification-service-devices
          uri: ${NOTIFICATION_SERVICE_URL:http://localhost:8086}
          predicates:
            - Path=/api/v1/devices/**
          filters:
            - name: CircuitBreaker
              args:
                name: notificationCircuitBreaker
                fallbackUri: forward:/fallback/notification

        - id: notification-service-internal
          uri: ${NOTIFICATION_SERVICE_URL:http://localhost:8086}
          predicates:
            - Path=/api/v1/internal/notify/**
          filters:
            - name: CircuitBreaker
              args:
                name: notificationCircuitBreaker
                fallbackUri: forward:/fallback/notification

        - id: notification-service-admin
          uri: ${NOTIFICATION_SERVICE_URL:http://localhost:8086}
          predicates:
            - Path=/api/v1/admin/notifications/**
          filters:
            - name: CircuitBreaker
              args:
                name: notificationCircuitBreaker
                fallbackUri: forward:/fallback/notification

        # ==========================================
        # SWAGGER AGGREGATION (per-service docs)
        # ==========================================
        - id: auth-swagger
          uri: ${AUTH_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/auth/api-docs/**,/auth/swagger-ui/**

        - id: task-swagger
          uri: ${TASK_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/task/api-docs/**,/task/swagger-ui/**

        - id: user-swagger
          uri: ${USER_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/user/api-docs/**,/user/swagger-ui/**

        - id: payment-swagger
          uri: ${PAYMENT_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/payment/api-docs/**,/payment/swagger-ui/**

        - id: rating-swagger
          uri: ${RATING_SERVICE_URL:http://localhost:8085}
          predicates:
            - Path=/rating/api-docs/**,/rating/swagger-ui/**

        - id: notification-swagger
          uri: ${NOTIFICATION_SERVICE_URL:http://localhost:8086}
          predicates:
            - Path=/notification/api-docs/**,/notification/swagger-ui/**

# ===== JWT =====
app:
  jwt:
    secret: ${APP_JWT_SECRET:YOUR_JWT_SECRET_KEY_CHANGE_THIS_IN_PRODUCTION_MIN_256_BITS_LONG_ENOUGH}
  gateway:
    # Paths that DON'T require JWT validation
    open-paths:
      - /api/v1/auth/register
      - /api/v1/auth/login
      - /api/v1/auth/refresh
      - /api/v1/auth/verify-otp
      - /api/v1/auth/forgot-password
      - /api/v1/ratings/user/**
      - /api/v1/ratings/summary/**
      - /actuator/health
      - /actuator/info
      - /fallback/**
      - /gateway/health
      - /**/swagger-ui/**
      - /**/api-docs/**

# ===== RESILIENCE4J CIRCUIT BREAKER =====
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
        permittedNumberOfCallsInHalfOpenState: 3
        slowCallDurationThreshold: 3000
        slowCallRateThreshold: 80
    instances:
      authCircuitBreaker:
        baseConfig: default
      taskCircuitBreaker:
        baseConfig: default
      userCircuitBreaker:
        baseConfig: default
      paymentCircuitBreaker:
        baseConfig: default
      ratingCircuitBreaker:
        baseConfig: default
      notificationCircuitBreaker:
        baseConfig: default
  timelimiter:
    configs:
      default:
        timeoutDuration: 10s
        cancelRunningFuture: true

# ===== ACTUATOR =====
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway
  endpoint:
    gateway:
      enabled: true

# ===== LOGGING =====
logging:
  level:
    org.springframework.cloud.gateway: INFO
    com.helper.gateway: DEBUG
    io.github.resilience4j: INFO
